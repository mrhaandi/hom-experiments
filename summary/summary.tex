\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bussproofs}
\usepackage{graphicx}
\usepackage{lmodern}
\usepackage{microtype}
\usepackage{csquotes}
\usepackage{xcolor}
\usepackage{hyperref}
\usepackage{stmaryrd}
\usepackage{xspace}

\usepackage[style=alphabetic,backend=bibtex]{biblatex}
\addbibresource{bibliography.bib}

\theoremstyle{plain}% default
\newtheorem{theorem}{Theorem}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{problem}[theorem]{Problem}
\newtheorem{example}[theorem]{Example}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{remark}[theorem]{Remark}

\title{Notes on Higher-Order Matching}
\author{Andrej Dudenhefner \and Aleksy Schubert}
\date{\today}

\begin{document}

\maketitle

\section{Bounded Parallel Intersection Type System}

We denote \emph{intersection types} by $A, B$, finite sets of intersection types by $\sigma, \tau$, and \emph{type atoms} by $a, b$.

\begin{definition}[Intersection Types]
\label{def:itypes}
$\begin{array}{rcl}
A, B &::=& a \mid \sigma \to A\\
\sigma, \tau &::=& \{A_1, \ldots, A_n\} \text{ where } n \geq 0
\end{array}$
\end{definition}

An \emph{environment}, denoted by $\Gamma$, is a finite set of \emph{type assumptions} having the shape $x : \sigma$ for distinct term variables.
\begin{definition}[Environment]
$\Gamma ::=\{x_1 : \sigma_1, \ldots, x_n : \sigma_n\}$ where $x_i \neq x_j$ for $i \neq j$.
\end{definition}
We may extend an environment $\Gamma$ by an additional assumption $x : \sigma$, written $\Gamma, x : \sigma$, where $x$ does not appear in any assumption in $\Gamma$.

We denote vectors of types and sets of types by $\bar{A}$ and $\bar{\sigma}$ respectively.
If $\bar{\sigma} = (\sigma_1, \ldots, \sigma_n)$ and $\bar{A} = (A_1, \ldots, A_n)$, then $\sigma \Rightarrow A = (\sigma_1 \to A_1, \ldots, \sigma_n \to A_n)$.

Extending notation~\cite{DudenhefnerU21} from surjective functions to binary relations we define type vector transformations as follows.

\begin{definition}[Type Vector Transformation]
Let $R \subseteq \{1, \ldots, n\} \times \{1, \ldots, m\}$ be a left-total and right-total binary relation.
\begin{itemize}
\item $R(A_1, \ldots, A_n) := (\tau_1, \ldots, \tau_m)$ where $\tau_i = \{A_j \mid j \, R\, i\}$
\item $R(\sigma_1, \ldots, \sigma_n) := (\tau_1, \ldots, \tau_m)$ where $\tau_i = \bigcup \{\sigma_j \mid j \, R\, i\}$
\item $R(\{x_1 : \sigma_1, \ldots, x_l : \sigma_l\}) := \{x_1 : R(\sigma_1), \ldots, x_l : R(\sigma_l)\}$
\end{itemize}
\end{definition}

\begin{example}
For $R = \{(1, 1), (1, 3), (2, 1), (3, 2), (3, 3)\}$ we have \[R(a, b, c) = (\{a, b\}, \{c\}, \{a, c\})\]
\end{example}

\begin{definition}[Parallel Intersection Type System]
\label{def:type-system}
~\\

\begin{minipage}{\textwidth}
\centering
\begin{tabular}{l}
{\RightLabel{\textnormal{(Ax)}}
\AxiomC{}
\UnaryInfC{$\{x : \bar{A}\} \vdash x : \bar{A}$}
\DisplayProof} \quad
{\RightLabel{\textnormal{($\omega$)}}
\AxiomC{}
\UnaryInfC{$\emptyset \vdash t : ()$}
\DisplayProof}\\\\
{\RightLabel{\textnormal{($\Rightarrow$I)}}
\AxiomC{$\Gamma, x: \bar{\sigma} \vdash t : \vec{A}$}
\UnaryInfC{$\Gamma \vdash \lambda x.t : \bar{\sigma} \Rightarrow \bar{A}$}
\DisplayProof}\quad
{\RightLabel{\textnormal{($\Rightarrow$E)}}
\AxiomC{$\Gamma \vdash t : R(\bar{A}) \Rightarrow \bar{B}$}
\AxiomC{$\Delta \vdash u : \bar{A}$}
\BinaryInfC{$\Gamma \cup R(\Delta) \vdash t \; u : \bar{B}$}
\DisplayProof}
\end{tabular}
\end{minipage}
\end{definition}

Similar systems:
\begin{itemize}
\item The system $\lambda^{\mbox{CIL}}$ by Wells et al
  \cite{WellsDMT02} (see \cite{WellsH02} for a simplified version of
  the system) is a system in Church style with explicit type
  annotations in $\lambda$-biders where different derivations for the
  same subterm are managed by means of records. A record of types with
  labels from $I$ is derived here by a record of terms of
  corresponding labels from $I$.
\item The proof system ISL presented by Pimentel, Ronchi Della Rocca
  and Roversi \cite{PimentelRR12} features independent derivations in
  tuples led according to the same proof rules. Effectively this works
  like an intersection type system with vectors. However, the system
  does not have proof terms. A version of the proof system formulated
  in terms of a sequent calculus is presented in \cite{RoccaSSV10}.
\end{itemize}

Dissimilar systems:
\begin{itemize}
\item The system by Luigi Liquori and Simona Ronchi della Rocca
  \cite{LiquoriR07} is a system with explicit annotations at
  $\lambda$-binders. It introduces  terms in which variables in
  binders are annotadet with indices. Then these indices serve as
  pointers to binders in derivations, and the binders in derivations
  contain types.
\end{itemize}


\begin{example}~\\
Let 
\begin{itemize}
\item $\Gamma_1 = \{x : (\{b, c\} \to a)\}$
\item $\Gamma_2 = \{y : (a \to b, a \to c), z : (a, a)\}$
\item $R_1 = \{(1,1), (2,1)\}$
\item $R_2 = \{(1,1), (1,2)\}$
\end{itemize}
We have the following derivation


\AxiomC{$\Gamma_1 \vdash x : R_1(b, c) \Rightarrow (a)$}
\AxiomC{$\{y : (a \to b, a \to c)\} \vdash y : R_2(a) \Rightarrow (b, c)$}
\AxiomC{$\{z : (a)\} \vdash z : (a)$}
\BinaryInfC{$\Gamma_2 \vdash y\,z : (b, c)$}
\BinaryInfC{$\Gamma_1 \cup R_1(\Gamma_2) \vdash x\,(y\,z) : (a)$}
\DisplayProof
\end{example}


\begin{definition}[Dimensional Restriction]
$\Gamma \vdash_k t : \bar{A}$ means that the length of vectors in some derivation of $\Gamma \vdash t : \bar{A}$ is at most $k$.
\end{definition}

\begin{theorem}
$\Gamma \vdash_{\textnormal{CDV}} t : A$ iff for some $k$ we have $\Gamma \vdash_k t : (A)$.
\end{theorem}

\begin{proposition}
Given $\Gamma$, $\bar{A}$, and $k$ it is decidable whether $\Gamma \vdash_k t : \bar{A}$ holds for some $t$.
\end{proposition}

\begin{proof}[(Proof Idea)]
In order to decide whether $\Gamma \vdash_k t : \bar{A}$ holds for some $t$, it suffices to consider $t$ in $\beta$-normal form.
For an \textsf{ASPACE} decision algorithm we need to limit the effective number of variables in type environments.
Assume $x : \bar{\sigma}$ occurs in some environment for an inhabitant in $\beta$-normal form.
Then each type $B$ which occurs in each set in each component of $\bar{\sigma}$ is a subformula of some type occurring in $\Gamma$ or $A$.
Therefore, there is finitely many distinct $\bar{\sigma}$.
By the pigeonhole principle, if there are more variables in a type environment, some must have identical types and thus a redundant copy can be removed.
Therefore, there are finitely many environements and types to consider throughout the cesition procedure.
\end{proof}

\begin{remark}
For fourth order matching $k$ is the product for the number of fragments of the right-hand sides.
However, intersection types in $\Gamma$ come from subject expansion of an intersection typing for an arbitrary candidate solution.
Therefore, not a sufficient restriction (at first glance).
However, one can try to relate types in $\Gamma$ to given simple types in the given fourth-order matching problem, possibly obtaining a finite bound of occurring types.
\end{remark}

\begin{definition}[Refinement]
An intersection type $A$ refines a simple type $\varphi$, written $A \prec \varphi$ if
\begin{itemize}
\item $A$ is a constant and $\varphi = \bullet$
\item $A = \sigma \to B$ and $\varphi = \varphi_1 \to \varphi_2$ and $B \prec \varphi_2$ and for all $A_1 \in \sigma$ we have $A_1 \prec \varphi_1$ 
\end{itemize}
\end{definition}

\begin{definition}[Shift]
We consider type atoms as words of natural numbers.
\begin{itemize}
\item ${\downarrow_i}w = wi$
\item ${\downarrow_i}(\{A_1, \ldots, A_n\} \to A) = (\{{\downarrow_i}A_1, \ldots, {\downarrow_i}A_n\} \to {\downarrow_i}A)$
\end{itemize}
\end{definition}

For example ${\downarrow_2}(\{12, 3\} \to \varepsilon) = \{122, 32\} \to 2$.

\begin{lemma}[Equality Characterization]
If $r$ is in $\beta$-normal form and $\Phi \vdash_{\textnormal{STLC}} r : \varphi$ is a $\eta$-long derivation, then there exists $\Gamma$, $A$ such that
\begin{enumerate}
\item $\Gamma \prec \Phi$ and $A \prec \varphi$
\item $\Gamma \vdash r : A$
\item for all $t$ such that $\Phi \vdash_{\textnormal{STLC}} t : \varphi$ is an $\eta$-long derivation (not necessarily $\beta$-normal) and $\Gamma \vdash t : A$, then $t \twoheadrightarrow_\beta r$
\end{enumerate}
\end{lemma}

\begin{proof}[(Proof Idea)]
First we focus on $\beta$-normal forms.
The crucial step application.
Consider the example term $r = x\,r_1\,r_2$. By inversion we have $(x : \varphi_1 \to \varphi_2 \to \bullet) \in \Phi$ and $\Phi \vdash_{\textnormal{STLC}} r_i : \varphi_i$.
By induction hypothesis there are $\Gamma_1, A_1, \Gamma_2, A_2$ satisfying the above conditions.
We set $\Gamma = (x : {\downarrow_1} A_1 \to {\downarrow_2} A_2 \to \varepsilon) \cup {\downarrow_1}\Gamma_1 \cup {\downarrow_2}\Gamma_2$
and $A = \varepsilon$.
\end{proof}

\begin{lemma}[Disequality Characterization]
If $r$ is in $\beta$-normal form and $\Phi \vdash_{\textnormal{STLC}} r : \varphi$ is a $\eta$-long derivation, then there exists $\Gamma$, $A$ such that
\begin{enumerate}
\item $\Gamma \prec \Phi$ and $A \prec \varphi$
\item $\Gamma \vdash r : A$
\item for all $t$ such that $\Phi \vdash_{\textnormal{STLC}} t : \varphi$ is an $\eta$-long derivation (not necessarily $\beta$-normal) and $\Gamma \vdash t : A$, then $t \not\twoheadrightarrow_\beta r$
\end{enumerate}
\end{lemma}

\begin{example}
Consider $\Phi = \{g : \bullet \to \bullet \to \bullet, y : \bullet\}$ and $r = g\,y\,y$.
Terms $t$ in $\beta$-normal form with an $\eta$-long derivation of $\Phi \vdash t : \bullet$ such that $t \neq r$ are
\begin{enumerate}
\item $y$\\
This can be characterized by $\{y : \{\varepsilon\}\} \vdash y : \varepsilon$
\item $g\,t'\,t''$ such that $t' \neq y$, which means $t = g\,t_1\,t_2$.\\
This can be characterized by $\{g : \{{\downarrow_1}\{\varepsilon\} \to \{\} \to \varepsilon\}, \{\} \to \{\} \to {\downarrow_1}\{\varepsilon\} \} \vdash g\,t'\,t'' : \varepsilon$
\item $g\,t''\,t'$ such that $t' \neq y$, which means $t = g\,t_1\,t_2$.\\
This can be characterized by $\{g : \{\{\} \to {\downarrow_2}\{\varepsilon\} \to \varepsilon\}, \{\} \to \{\} \to {\downarrow_2}\{\varepsilon\} \} \vdash g\,t''\,t' : \varepsilon$
\end{enumerate}
Putting it all together we can take $\Gamma = \{y : \{\varepsilon\}, g : \{{\downarrow_1}\{\varepsilon\} \to \{\} \to \varepsilon, \{\} \to \{\} \to {\downarrow_1}\{\varepsilon\}, \{\} \to {\downarrow_2}\{\varepsilon\} \to \varepsilon\}, \{\} \to \{\} \to {\downarrow_2}\{\varepsilon\}\}$ and $A = \varepsilon$ such that $\Gamma \vdash t : A$.
\end{example}

\begin{example}
Consider $\Phi = \{f : (\bullet \to \bullet) \to \bullet, g : \bullet \to \bullet \to \bullet, y : \bullet\}$ and $r = f\,(\lambda x.g\,x\,y)$.
This extends the previos example.
Terms $t$ in $\beta$-normal form with an $\eta$-long derivation of $\Phi \vdash t : \bullet$ are
\begin{enumerate}
\item $y$\\
This can be characterized by $\{y : \{\varepsilon\}\} \vdash y : \varepsilon$
\item $g\,t_1\,t_2$\\
This can be characterized by $\{g : \{\} \to \{\} \to \varepsilon \} \vdash g\,t_1\,t_2 : \varepsilon$
\item $f\,(\lambda x.t')$ such that $t' \neq g\,x\,y$\\
Here we have $\Phi, x : \bullet : g\,x\,y : \bullet$ and can derive $\Gamma'$, $A' = \varepsilon$ as characterization for any $\beta$-normal $\eta$-long typed term different from $g\,x\,y$.
Let $\Gamma'' = \Gamma' \setminus \{x\}$
Overall we can take $\Gamma = \Gamma'' \cup \{y : \{\varepsilon\}, g : \{\} \to \{\} \to \varepsilon, f : \Gamma'(x) \to \varepsilon\}$ and $A = \varepsilon$.
\end{enumerate}
\end{example}

\begin{lemma}
\label{lem:transform}
If $\Gamma \vdash t : \bar{A}$ and $R$ is right-unique, then $R(\Gamma) \vdash t : R(\bar{A})$.
\end{lemma}

\begin{lemma}
If in a derivation of the judgment $\Gamma \vdash_k t : \bar{A}$ there occurs $\Delta \vdash_k u : \bar{B}$ such that for some distinct $i, j$
$B_i = B_j$ and $\forall x.\Delta(x)_i = \Delta(x)$, then there is a derivation of $\Gamma \vdash_k t : \bar{A}$ that has no such property (TODO rephrase).
\end{lemma}

\begin{proof}
Use Lemma~\ref{lem:transform} to collapse redundant entries and idempotence of intersection.
\end{proof}

\newpage

%Inductive solved (ap : aposition) (theta : lookup_contents) (l : nat):
%  option lookup_contents -> rose_tree (aposition * lookup_contents) -> Prop :=
%    | solved_abs k x args g:
%      get_arena_subterm TS ap = Some (tm k x args) ->
%      solved ap theta (k+l) (Some (map inr (seq l k))) g ->
%      solved ap theta l None g
%
%    | solved_var ts x args ap' theta' g:
%      get_arena_subterm TS ap = Some (tm (length ts) x args) -> (* get subarena at position ap *)
%      lookup_var (ts ++ theta) x = Some (ap', lk theta') -> (* get interpretation of x *)
%      solved ap' theta' l (Some (map (add_lk ap (ts ++ theta)) (seq 0 (length args)))) g ->
%      solved ap theta l (Some ts) (node (ap, ts ++ theta) [g])
%
%    | solved_const ts x args gs:
%      get_arena_subterm TS ap = Some (tm (length ts) x args) ->
%      lookup_var (ts ++ theta) x = None ->
%      length gs = length args ->
%      (forall j g, nth_error gs j = Some g -> solved (extend_ap ap [j]) (ts ++ theta) l None g) ->
%      solved ap theta l (Some ts) (node (ap, ts ++ theta) gs).

\newcommand{\p}{\mathtt{p}\xspace}

\begin{definition}[solved]~\\

  $A, \p, \theta \Yright G\mapsto r$
  \begin{itemize}
  \item In arena $A$
  \item at position $\p$
  \item with help of lookup table $\theta$
  \item the game tree $G$ develops to the result $r$
  \end{itemize}
\end{definition}

\begin{proposition}
  If
  \begin{itemize}
  \item $A$ - is an arena
  \item $\p$ - is a position in $A$
  \item $\theta$ - is a lookup table (including binder at $\p$)
  \item \emph{some condition on derivability in $\theta$}
  \item $A, \p, \theta \Yright G\mapsto r$
  \end{itemize}
  then there is a derivation $\Gamma_\theta\vdash \p'(A) : \alpha_r$.
\end{proposition}

\begin{proposition}
  If
  \begin{itemize}
  \item $A$ - is an arena
  \item $\p$ - is a position in $A$
  \item $\theta$ - is a lookup table (including binder at $\p$)
  \item \emph{some condition on derivability in $\theta$}
  \item and there is a derivation $\Gamma_\theta\vdash \p'(A) : \alpha_r$. 
  \end{itemize}
  then there is a game tree $G$ in $A$ such that $A,\p,\theta\Yright
  G\mapsto r$.
\end{proposition}

\newpage

\section{Subject reduction}

\subsection{System}

\begin{minipage}{\textwidth}
\centering
\begin{tabular}{l}
  {
  \RightLabel{\textnormal{(Ax)}}
  \AxiomC{
  \parbox{5cm}{
  $A_i\in \sigma_i$ for $i=1...m$\\
  with $\bar{A} = (A_1,\ldots,A_m)$\\
  $\bar{\sigma} = (\sigma_1,\ldots,\sigma_m)$
  }}
  \UnaryInfC{$\Gamma, x : \bar{\sigma}  \vdash x : \bar{A}$}
  \DisplayProof
  } \quad
%
  {
  \RightLabel{\textnormal{($\omega$)}}
  \AxiomC{}
  \UnaryInfC{$\emptyset \vdash t : ()$}
  \DisplayProof
  }\\\\
%
%
  {
  \RightLabel{\textnormal{($\Rightarrow$I)}}
  \AxiomC{%
  \parbox{5cm}{
  $\Gamma, x: \sigma_i \vdash t : A_i$ for $i=1...m$\\
  with $\bar{A} = (A_1,\ldots,A_m)$\\
  $\bar{\sigma} = (\sigma_1,\ldots,\sigma_m)$}
  }
  \UnaryInfC{$\Gamma \vdash \lambda x.t : \bar{\sigma} \Rightarrow \bar{A}$}
  \DisplayProof
  }\quad
%
  {
  \RightLabel{\textnormal{($\Rightarrow$E)}}
  \AxiomC{$\Gamma \vdash t : R(\bar{A}) \Rightarrow \bar{B}$}
  \AxiomC{$\Delta \vdash u : \bar{A}$}
  \BinaryInfC{$\Gamma \uplus R(\Delta) \vdash t \; u : \bar{B}$}
  \DisplayProof
  }
\end{tabular}
\end{minipage}



\bigskip

Assume that $C = a\to a$. We use the relation $R = \{(1,1)\}$ in the
($\Rightarrow$E) rule below.

\[
  \begin{gathered}
    \RightLabel{\scriptsize (Ax)}
    \AxiomC{$C\to C \in \{C\to C, C\}$}
    \UnaryInfC{$x:\{C\to C, C\} \vdash x : (C\to C)$}
    \RightLabel{\scriptsize (Ax)}
    \AxiomC{$C \in \{C\to C, C\}$}
    \UnaryInfC{$x:\{C\to C, C\} \vdash x : (C)$}
    \RightLabel{\scriptsize ($\Rightarrow$E)}
    \BinaryInfC{$x : \{C\to C, C\} \vdash xx : C$}
    \RightLabel{\scriptsize ($\Rightarrow$I)}
    \UnaryInfC{$\vdash \lambda x.xx : (\{C\to C, C\} \to C)$}
    \DisplayProof
\end{gathered}
\]

We now apply this function to the identity as follows, with $R =
\{(1,1),(2,1)\}$
in the ($\Rightarrow$E) rule below.

\[
\AxiomC{$\vdash \lambda x.xx : (\{C, a\} \to a)$}
\AxiomC{$y:C\in\{y:C\}$}
\UnaryInfC{$y:C\vdash y : C$}
\AxiomC{$y:a\in\{y:a\}$}
\UnaryInfC{$y:a\vdash y : a$}
\RightLabel{\scriptsize ($\Rightarrow$I)}
\BinaryInfC{$ \vdash \lambda y.y : (C\to C,C)$}
\RightLabel{\scriptsize ($\Rightarrow$E)}
\BinaryInfC{$\vdash (\lambda x.xx)\,I:(C)$}
\DisplayProof
\]

\begin{lemma}[substitution lemma]
  ~\\
  Assume $\bar{A} = (A_1,\ldots,A_n)$ and $\bar{B} =
  (B_1,\ldots,B_m)$, and $\bar{\sigma} =
  (\sigma_1,\ldots,\sigma_m)$.
  If $\Gamma, x:\sigma_i\vdash t : B_i$ %
  for $i=1,\ldots,m$ and $R$ is such that $\sigma_i = \{A_j \mid j\, R\, i\}$
  and $\Delta\vdash u : \bar{A}$ %
  then $\Gamma\uplus R(\Delta) \vdash t[x:=u] : \bar{B}$.
  
\end{lemma}
\begin{proof}
  Induction over $t$.

  \begin{itemize}
  \item $t=y$
    \begin{itemize}
    \item $y=x$ -- due to $R$ we can extract from the derivation for
      $u$ all the necessary derivations for $B$'s.
    \item $y\not=x$
    \end{itemize}
  \item $t=vw$ -- we have in the last derivation rule a relation
    $R'$. For the derivation of $w$ we need to adapt $R$ to take into
    account $R'$. This should be $R;R'^{-1}$.
  \item $t=\lambda y.u$ -- congruence.
  \end{itemize}
\end{proof}


\newpage

\section{Application to Fourth-order Matching}


\newpage

\section*{TODOs}
\begin{remark}[Open Questions]~
\begin{itemize}
\item do we have subject expansion in bounded dimension and fixed rank 2?
\item do we have subject expansion in bounded dimension and fixed order 3?
\item (alx) cleaning the note
\item (alx) layout the statement of the dimension lemma
\item (alx) layout the sketch ot the proof of the dimension lemma
\end{itemize}

\newpage

\printbibliography
\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
